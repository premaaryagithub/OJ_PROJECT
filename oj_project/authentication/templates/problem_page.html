{% extends "home.html" %}
{% block content %}

<!-- CodeMirror Assets -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/clike/clike.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  overflow: hidden;
  font-family: 'Poppins', sans-serif;
}

.problem-page {
  display: flex;
  height: 85vh;
  width: 100vw;
  background-color: #f4f2fa;
  position: relative;
}

.left-panel, .right-panel {
  padding: 24px;
  overflow-y: auto;
  background-color: #ffffff;
  box-shadow: inset 0 0 6px rgba(0,0,0,0.05);
  height: 100%;
}

.left-panel {
  width: 50%;
}

.right-panel {
  width: 50%;
}

.resizer {
  width: 6px;
  background-color: #ccc;
  cursor: ew-resize;
  position: absolute;
  top: 0;
  bottom: 0;
  left: 50%;
  z-index: 10;
}

.left-panel h2 {
  font-size: 28px;
  font-weight: 700;
  color: #4a2db6;
  border-bottom: 2px solid #e3dffc;
  padding-bottom: 10px;
  margin-bottom: 20px;
}

.problem-description,
.format-section p {
  font-size: 16px;
  line-height: 1.6;
  color: #333;
  white-space: pre-wrap;
}

.format-section h4 {
  font-size: 18px;
  color: #4a2db6;
  margin-top: 20px;
  margin-bottom: 6px;
}

.testcase {
  border-left: 4px solid #4a2db6;
  background-color: #f9f7ff;
  padding: 14px;
  border-radius: 10px;
  margin-bottom: 16px;
  font-family: monospace;
}

.testcase-section h4 {
  font-size: 14px;
  color: #222;
  margin-bottom: 4px;
}

.testcase-content {
  background-color: #ffffff;
  border: 1px dashed #ccc;
  padding: 10px 12px;
  border-radius: 6px;
  white-space: pre-wrap;
}

textarea#code {
  width: 100%;
  height: 38vh;
  background-color: #1e1e1e;
  color: #dcdcdc;
  font-family: monospace;
  border: none;
  border-radius: 8px;
  padding: 14px;
  font-size: 14px;
  box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
  caret-color: white;
  resize: vertical;
  margin-bottom: 16px;
}

select {
  width: 100%;
  padding: 10px;
  font-size: 15px;
  margin-bottom: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background-color: #fefefe;
}

.button-bar {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-bottom: 20px;
}

.button-bar button {
  padding: 8px 14px;
  font-size: 14px;
  font-weight: 600;
  background-color: #5c2dab;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.3s;
}

.button-bar button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
  background-color: #4a148c;
}

.verdict-box {
  padding: 14px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 15px;
  background-color: #eae6ff;
  color: {% if verdict == 'Accepted' %}green{% else %}crimson{% endif %};
  border: 1px solid {% if verdict == 'Accepted' %}green{% else %}crimson{% endif %};
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  animation: fadeIn 0.5s ease-in-out;
  margin-top: 20px;
}

.output-box, .error-box {
  background-color: #fefefe;
  padding: 14px;
  border: 1px dashed #999;
  border-radius: 8px;
  margin-bottom: 14px;
  white-space: pre-wrap;
  font-family: monospace;
  font-size: 14px;
}

.testcase-result {
  border-radius: 8px;
  padding: 12px;
  margin-bottom: 12px;
  background-color: #f3f3f3;
  border-left: 6px solid;
}

.testcase-result.passed {
  border-color: green;
  color: green;
}

.testcase-result.failed {
  border-color: crimson;
  color: crimson;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
#editor {
  height: 38vh;
  border-radius: 8px;
  font-size: 14px;
  box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.3);
  margin-bottom: 16px;
}

</style>

<div class="problem-page" id="problemPage">
  <div class="left-panel" id="leftPanel">
    <h2>{{ problem.title }}</h2>
    <p class="problem-description">{{ problem.description }}</p>

    <div class="format-section">
      <h4>Input Format</h4>
      <p>{{ problem.input_format }}</p>
    </div>

    <div class="format-section">
      <h4>Output Format</h4>
      <p>{{ problem.output_format }}</p>
    </div>

    <div class="testcase-block">
      <h3>Sample Test Cases</h3>
      {% for tc in testcases|slice:":2" %}
        <div class="testcase">
          <div class="testcase-section">
            <h4>Input</h4>
            <div class="testcase-content">{{ tc.input_data }}</div>
          </div>
          <div class="testcase-section">
            <h4>Expected Output</h4>
            <div class="testcase-content">{{ tc.expected_output }}</div>
          </div>
        </div>
      {% empty %}
        <p><em>No test cases available for this problem yet.</em></p>
      {% endfor %}
    </div>
  </div>

  <div class="resizer" id="resizer"></div>

  <div class="right-panel" id="rightPanel">
    <form method="POST" action="{% url 'problem_detail' problem.id %}">
      {% csrf_token %}

      <textarea name="code" id="code" style="display:none"></textarea>


      <label for="editor">Your Code:</label>
      <div id="editor"></div>

      <label for="language">Select Language:</label>
      <select name="language" id="language" required>
        <option value="python" {% if language == "python" %}selected{% endif %}>Python</option>
        <option value="cpp" {% if language == "cpp" %}selected{% endif %}>C++</option>
        <option value="java" {% if language == "java" %}selected{% endif %}>Java</option>
      </select>

      <div class="button-bar">
        <button type="submit" name="action" value="run">Run</button>
        <button type="submit" name="action" value="submit">Submit</button>
      </div>
    </form>

<form method="post" action="{% url 'ai_review' %}" style="margin-top: 20px;">
  {% csrf_token %}
  <input type="hidden" name="problem_id" value="{{ problem.id }}">
  <input type="hidden" name="code" id="code">
  <input type="hidden" name="language" id="languageField">
  <button type="submit" onclick="
    document.getElementById('code').value = editor.getValue();
    document.getElementById('languageField').value = document.getElementById('language').value;
  " style="
    background-color: #5c4bc9;
    color: white;
    padding: 10px 24px;
    font-weight: bold;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  ">üß† AI Review</button>
</form>


    {% if verdict %}
      <div class="verdict-box" style="margin-top: 20px;">Verdict: {{ verdict }}</div>
    {% endif %}

{% if ai_response %}
  <div style="margin-top: 25px; padding: 18px; background-color: #f1f0ff;
              border-left: 5px solid #5c4bc9; border-radius: 6px;">
    <h4>üí¨ AI Response</h4>
    <p>{{ ai_response }}</p>
  </div>
{% endif %}


      {% if action == "run" and testcase_results %}
        <h3 style="margin-top: 30px;">üß™ Testcase Results</h3>
        <div style="display: flex; flex-direction: column; gap: 14px;">
          {% for result in testcase_results %}
            <div style="border-radius: 8px; border-left: 6px solid {% if result.verdict == 'Passed' %}green{% else %}crimson{% endif %}; background-color: #f3f3f3; padding: 12px;">
              <strong>Testcase {{ result.number }} ‚Äî 
                <span style="color:{% if result.verdict == 'Passed' %}green{% else %}crimson{% endif %};">
                  {{ result.verdict }}
                </span>
              </strong><br>
              <div><strong>Input:</strong> {{ result.input }}</div>
              <div><strong>Expected Output:</strong> {{ result.expected }}</div>
              <div><strong>Your Output:</strong> {{ result.actual }}</div>
              {% if result.error %}
                <div style="color: crimson;"><strong>Error:</strong> {{ result.error }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}
{% if action == "submit" and testcases %}
  <h3 style="margin-top: 30px;">üîí Testcase Results</h3>
  <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 10px;">
    {% for result in testcases %}
      <div style="
        padding: 10px 16px;
        border-radius: 6px;
        background-color: {% if result.verdict == 'Passed' %}#28a745{% else %}#8B0000{% endif %};
        color: white;
        font-weight: bold;
        min-width: 120px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      ">
        Testcase {{ result.number }} 
        {% if result.verdict == 'Passed' %}
          ‚úÖ
        {% else %}
          ‚ùå
        {% endif %}
      </div>
    {% endfor %}
  </div>
{% endif %}


 

    </div>
  </div>

  <script>
  const resizer = document.getElementById('resizer');
  const leftPanel = document.getElementById('leftPanel');
  const rightPanel = document.getElementById('rightPanel');
  const container = document.getElementById('problemPage');

  let isResizing = false;

  resizer.addEventListener('mousedown', function(e) {
    isResizing = true;
    document.body.style.cursor = 'ew-resize';
  });

  document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    const containerRect = container.getBoundingClientRect();
    const offsetX = e.clientX - containerRect.left;
    const totalWidth = containerRect.width;

    const leftWidth = Math.max(250, Math.min(offsetX, totalWidth - 250));
    const rightWidth = totalWidth - leftWidth;

    leftPanel.style.width = `${leftWidth}px`;
    rightPanel.style.width = `${rightWidth}px`;
    resizer.style.left = `${leftWidth}px`;
  });

  document.addEventListener('mouseup', function() {
    isResizing = false;
    document.body.style.cursor = 'default';
  });



const modeMap = {
    python: "python",
    cpp: "text/x-c++src",
    java: "text/x-java"
  };

  const boilerplateMap = {
    python: `def main():
    # Write your Python code here
if __name__ == '__main__':
    main()`,

    cpp: `#include <iostream>
using namespace std;

int main() {
    // Write your C++ code here
    return 0;
}`,

    java: `public class Main {
    public static void main(String[] args) {
        // Write your Java code here
    }
}`
  };

  const languageSelect = document.getElementById("language");

  // Store user-written code per language
  const codeMap = {};

const initialCode = `{{ code|escapejs }}`;
const selectedLang = "{{ language }}";  // already defined
const initialLanguage = selectedLang;   // ‚úÖ Add this line



const editor = CodeMirror(document.getElementById("editor"), {
  value: (initialCode && initialCode !== "None") ? initialCode : boilerplateMap[selectedLang],
  mode: modeMap[selectedLang],
  theme: "dracula",
  lineNumbers: true,
  indentUnit: 4,
  tabSize: 4,
  matchBrackets: true,
  autoCloseBrackets: true
});

  // Save initial code to codeMap
  codeMap[initialLanguage] = editor.getValue();

  // Handle language switching
  languageSelect.addEventListener("change", function () {
    const newLang = this.value;

    // Save current code before switching
    const currentLang = editor.getOption("mode");
    const currentCode = editor.getValue();
    const currentLangKey = Object.keys(modeMap).find(key => modeMap[key] === currentLang);
    if (currentLangKey) {
      codeMap[currentLangKey] = currentCode;
    }

    // Switch mode
    editor.setOption("mode", modeMap[newLang]);

    // Load saved code or fallback to boilerplate
    const savedCode = codeMap[newLang];
    editor.setValue(savedCode !== undefined ? savedCode : boilerplateMap[newLang]);
  });

  // Update hidden #code field before form submission
  document.querySelectorAll("form").forEach(function(form) {
    form.addEventListener("submit", function () {
      document.getElementById("code").value = editor.getValue();
    });
  });
</script>

  {% endblock %}